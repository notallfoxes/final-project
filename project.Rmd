---
title: "Webtoons Project"
author: "Tonia Wu"
output:
  html_document:
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(tidymodels)
library(ggplot2)
library(janitor)
library(splitstackshape)
library(randomForest)
library(ggpubr)
library(ggmosaic)
# library(tune)
library(dplyr)
library(rpart.plot)
# library(yardstick)
# library(klaR)
# library(discrim)
# library(poissonreg)
# library(pROC)
# library(MASS)
# library(glmnet)
```


# Introduction 
## What are Webtoons?
Webtoons are a type of digital comic from South Korea designed for vertical scrolling on computers and mobile devices. They are often published in full color and may feature music and animations.

![Some famous Webtoons](images/banner.jpg)

# Webtoon Styles

## Standard

## Simplified Cartoon

## Realistic Standard

## American

## Korean Realism

# Loading Data
For this project, we wil be working with data from the English platform of Webtoons. The file is from Kaggle: https://www.kaggle.com/datasets/iridazzle/webtoon-originals-datasets.

Webtoons do not come with information on their art style or their author's country of origin, so I had to manually input them. 

The raw file contains data on the genre, authors, weekdays uploaded, number of free episodes, subscriber count, views, likes, upload status, and the synopsis:
```{r }
rawdata <- read.csv('webtoon_originals_en.csv')
```
```{r class.source = 'fold-show'}
head(rawdata)
```

The variables we will look at (also in the codebook):

* `title`
* `genre`

Before we can proceed, we will need to clean and unstack some of the columns.

# Data Cleaning

Here are the steps I took to prepare the data.

* Cleaning the names

```{r }
webtoons <- rawdata %>%
  clean_names()
```

* Adding a new variable called `synopsis_length` to quantify the `synopsis`, since I'm curious if it will make an impact
```{r , results = 'hide'}
webtoons <- webtoons %>%
  mutate(synopsis_length = str_count(synopsis)) 
```

* Dropping unhelpful variables, such as `title_id`
```{r , results = 'hide'}
webtoons <- webtoons%>%
  dplyr::select(-c(authors, title_id, synopsis))
```

* Renaming the length column to the more descriptive 'free_episodes' to avoid confusion:
```{r }
webtoons <- webtoons %>%
  rename(free_episodes = length)
```

# Exploratory Data Analysis

Because Webtoons are relatively new and generally more popular with younger audiences, I expect there to be an uneven genre distribution. Let's take a look:

```{r }
bchart1 <- ggplot(data = webtoons, aes(x = genre)) +
  geom_bar() + 
  coord_flip() + 
  labs(y = 'Count', x = 'Genre')

bchart1
```
The two dominating categories, fantasy and romance, as well as the next group of popular genres, have broad appeal. This is not too surprising. We must also remember that a single webtoon may encompass more than one genre.

One of the least popular genres is called a "Tiptoon." These are informative webtoons that the platform  sometimes asks its creators to illustrate, giving tips on subjects such as how to stay healthy during the pandemic and how to edit your webtoon. As they are not a regular fictive comic, we will drop the genre.

```{r}
webtoons <- subset(webtoons, genre != 'TIPTOON')
```

I also suspect budding authors to look at the synopses of established creators in their genres as inspiration. Let's see if synopsis lengths are generally similar within their genres.

```{r }
boxplot <- ggplot(webtoons, aes(x=synopsis_length, y=genre)) + 
  geom_boxplot()
boxplot
```
Since we do see some fundamental differences in median synopsis length, such as with the slice of life and the historical genres, we will retain `synopsis_length`.

Now let's look at the distribution of our outcome variable, `style`.

```{r }
bchart2 <- ggplot(data = webtoons, aes(x = style)) +
  geom_bar() + 
  coord_flip() + 
  labs(y = 'Count', x = 'style')

bchart2
```
Not surprisingly, most webtoons are of the standard style, with deviations from it becoming less common.

Next we will explore each genre's popularity. Webtoons offers four metrics to judge this: `rating`, on a scaled of 1 to 10 (with steps of 0.5), `likes`, `views`, and `subscribers`.

```{r }

likes_plot <- ggplot(webtoons, aes(reorder(style, likes), likes)) +
  geom_boxplot(varwidth = TRUE) + 
  labs(
    title = "Likes by Style",
    x = "Style"
  ) + coord_trans(x = 'log2', y = 'log2')

views_plot <- ggplot(webtoons, aes(reorder(style, views), views)) +
  geom_boxplot(varwidth = TRUE) + 
  labs(
    title = "Views by Style",
    x = "Style"
  ) + coord_trans(x = 'log2', y = 'log2')

subs_plot <- ggplot(webtoons, aes(reorder(style, subscribers), subscribers)) +
  geom_boxplot(varwidth = TRUE) + 
  labs(
    title = "Subscribers by Style",
    x = "Style"
  ) + coord_trans(x = 'log2', y = 'log2')

rating_plot <- ggplot(webtoons, aes(reorder(style, rating), rating)) +
  geom_boxplot(varwidth = TRUE) + 
  labs(
    title = "Rating by Style",
    x = "Style"
  ) + coord_trans(x = 'log2', y = 'log2')

ggarrange(likes_plot, views_plot, subs_plot, rating_plot,
          ncol = 2, nrow = 2)
```
Interestingly, the American style consistently ranks the lowest, while the others all swap order at some point. This should not come as a surprise, since Webtoons is a Korean platform, so readers may prefer a more Asian style.

```{r }
ggplot(webtoons, aes(reorder(style, free_episodes), free_episodes)) +
  geom_boxplot(varwidth = TRUE) + 
  labs(
    title = "Rating by Style",
    x = "Style"
  ) 
```


I expect most ratings to be around 7+, since people will probably take points off from 10 and only save lower ratings for comics they vehemently dislike. (Thus I do not trust ratings to accurately gauge webtoon quality.)

Interestingly, as the styles begin to depart from the standard style, the ratings are less polarized toward 10. Most notably the American style comics are the least favored. The density curve is even bimodal.

```{r }
ggplot(data = webtoons) + 
  geom_mosaic(aes(x=product(style, genre), fill = style),
              divider=c("vspine", "hbar")) +   
  labs(x="genre", y = "style", title = "Stacked Bar Chart") + coord_flip() 
```
Surprisingly, while the American style makes up most of the superhero genre, the superhero genre does not appear to make up most of the American style comics.

We can also see that the bulk of the cartoon styles are in slice of life comics. This is the only style that dominates a single style.

# Dummy coding

Quite a few of the variables are not numeric. Now that we've explored the data, we will now unpack the categorical variables into more specific ones.

Let's parse `status`, `original_platform`, `genre`, and the days of the week variables into boolean columns.

* `status`
```{r, results='hide'}
webtoons <- webtoons %>%
  mutate(n = 1) %>%
  pivot_wider(names_from = status, values_from = n, values_fill = list(n = 0))
```

* `original_platform`
Parsing the platforms into boolean columns:
```{r, results='hide'}
webtoons <- webtoons %>%
  mutate(n = 1) %>%
  pivot_wider(names_from = original_platform, values_from = n, values_fill = list(n = 0))
```

* `genre`
Parsing the genres into boolean columns:
```{r, results='hide'}
webtoons <- webtoons %>%
  mutate(n = 1) %>%
  pivot_wider(names_from = genre, values_from = n, values_fill = list(n = 0))

# Lowercase all column names
names(webtoons) <- tolower(names(webtoons))
```

* days of the week
```{r, results='hide'}
webtoons <- cSplit_e(webtoons, 'weekdays', sep = ',', mode = 'binary',
         type = 'character', fill = 0, drop = TRUE)

# renaming
colnames(webtoons)[colnames(webtoons) == 'weekdays_SUNDAY'] <- 'sunday'
colnames(webtoons)[colnames(webtoons) == 'weekdays_MONDAY'] <- 'monday'
colnames(webtoons)[colnames(webtoons) == 'weekdays_TUESDAY'] <- 'tuesday'
colnames(webtoons)[colnames(webtoons) == 'weekdays_WEDNESDAY'] <- 'wednesday'
colnames(webtoons)[colnames(webtoons) == 'weekdays_THURSDAY'] <- 'thursday'
colnames(webtoons)[colnames(webtoons) == 'weekdays_FRIDAY'] <- 'friday'
colnames(webtoons)[colnames(webtoons) == 'weekdays_SATURDAY'] <- 'saturday'
```

* `daily_pass`:

```{r}
webtoons$daily_pass <- ifelse(webtoons$daily_pass == TRUE, 1, 0)
head(webtoons)
```

# Factors
Now we will convert our categorial variables into factors.

* `style` and `daily_pass`
```{r }
webtoons$style <- as.factor(webtoons$style)
webtoons$daily_pass <- as.factor(webtoons$daily_pass)
```

* platforms:
```{r }
webtoons$english <- as.factor(webtoons$english)
webtoons$korean <- as.factor(webtoons$korean)
webtoons$japanese <- as.factor(webtoons$japanese)
webtoons$indonesian <- as.factor(webtoons$indonesian)
```

* genres
```{r }
webtoons$action <- as.factor(webtoons$action)
webtoons$comedy <- as.factor(webtoons$comedy)
webtoons$drama <- as.factor(webtoons$drama)
webtoons$fantasy <- as.factor(webtoons$fantasy)
webtoons$heartwarming <- as.factor(webtoons$heartwarming)
webtoons$historical <- as.factor(webtoons$historical)
webtoons$horror <- as.factor(webtoons$horror)
webtoons$mystery <- as.factor(webtoons$mystery)
webtoons$romance <- as.factor(webtoons$romance)
webtoons$slice_of_life <- as.factor(webtoons$slice_of_life)
webtoons$scifi <- as.factor(webtoons$scifi)
webtoons$sports <- as.factor(webtoons$sports)
webtoons$super_hero <- as.factor(webtoons$super_hero)
webtoons$supernatural <- as.factor(webtoons$supernatural)
webtoons$thriller <- as.factor(webtoons$thriller)
```

* statuses:
```{r}
webtoons$ongoing <- as.factor(webtoons$ongoing)
webtoons$completed <- as.factor(webtoons$completed)
webtoons$hiatus <- as.factor(webtoons$hiatus)
```

* days of the week:
```{r}
webtoons$monday <- as.factor(webtoons$monday)
webtoons$tuesday <- as.factor(webtoons$tuesday)
webtoons$tuesday <- as.factor(webtoons$tuesday)
webtoons$wednesday <- as.factor(webtoons$wednesday)
webtoons$thursday <- as.factor(webtoons$thursday)
webtoons$friday <- as.factor(webtoons$friday)
webtoons$saturday <- as.factor(webtoons$saturday)
webtoons$sunday <- as.factor(webtoons$sunday)
```


# Model setup

## Data Split

We will allocate 80% of the data to the training set and 20% to the testing set.
```{r}
set.seed(66)
w_split <- initial_split(webtoons, prop = 0.8, strata = 'style')
w_train <- training(w_split)
w_test <- testing(w_split)
```

* Checking our data split in correct percentages:
```{r}
dim(w_train)
```

```{r}
dim(w_test)
```

```{r}
dim(webtoons)
```

## Folding data
Now we will perform v-fold cross validation with 10 folds, stratifying by `style`.
```{r}
w_folds <- vfold_cv(data = w_train, v = 10, strata = 'style')
```

## Recipe
Setting up recipe to predict `style`:
```{r}
w_recipe <- recipe(style ~ rating + views  + daily_pass + free_episodes  + likes + subscribers + synopsis_length + monday + tuesday + wednesday + thursday + friday + saturday + sunday + ongoing + completed + hiatus + english + korean + japanese + indonesian + action + comedy + drama + fantasy + heartwarming + historical + horror + mystery + romance + scifi + slice_of_life + sports + super_hero + supernatural + thriller,
                   data = w_train) %>%
  step_dummy(c(daily_pass, monday, tuesday, wednesday, thursday, friday, saturday, sunday, ongoing, completed, hiatus, english, korean, japanese, indonesian, action, comedy, drama, fantasy, heartwarming, historical, horror, mystery, romance, scifi, slice_of_life, sports, super_hero, supernatural, thriller)) %>%
  step_normalize(all_predictors())
```

# Modeling

I decided to run the following models thanks to my dataset being dominated by categorical variables:

* multinomial logistic regression
* random forest
* boosted trees
* nearest neighbors

## Multinomial logistic regression

We will tune `penalty` and `mixture`. Since our outcome is `style`, `mode` is set to `classification`.
```{r}
multinom_mod <- multinom_reg(penalty = tune(),
                        mixture = tune()) %>%
  set_engine('glmnet') %>%
  set_mode('classification')

multinom_wkflow = workflow() %>%
  add_model(multinom_mod) %>%
  add_recipe(w_recipe)

multinom_grid = grid_regular(penalty(range = c(-5, 5)),
                       mixture(range = c(0, 1)),
                       levels = 10)

multinom_tune <- tune_grid(object = multinom_wkflow,
                        resamples = w_folds,
                        grid = multinom_grid)

autoplot(multinom_tune)
```

## Random forest
```{r}
rf_mod <-
  rand_forest(min_n = tune(), mtry = tune()) %>%
  set_mode('classification') %>%
  set_engine('randomForest')

rf_wkflow <- workflow() %>%
  add_model(rf_mod) %>%
  add_recipe(w_recipe)

rf_grid <- grid_regular(min_n(),
                        mtry(range = c(1, 7)),
                        levels = 3)

rf_tune <- rf_wkflow %>%
  tune_grid(resamples = w_folds,
    grid = rf_grid)

rf_tune %>% collect_metrics() %>%
  select(-.estimator, -.config)
```

# Boosted trees
```{r}
boost_mod <- boost_tree(trees = tune()) %>%
  set_engine('xgboost') %>%
  set_mode('classification')

boost_wkflow <- workflow() %>%
  add_model(boost_mod) %>%
  add_recipe(w_recipe)

boost_grid <- grid_regular(trees(c(10,100)),
                           levels = 3)

tune_boost <- tune_grid(
  boost_wkflow,
  resamples = w_folds,
  grid = boost_grid
)

tune_boost %>% collect_metrics() %>% 
  select(-.estimator, -.config)

autoplot(tune_boost)
```

# Decision tree
```{r}
tree_mod <- decision_tree() %>%
  set_engine('rpart')

tree_spec <- tree_mod %>%
  set_mode('classification')

tree_fit <- tree_spec %>%
  fit(style ~ rating + views  + daily_pass + free_episodes  + likes + subscribers + synopsis_length + monday + tuesday + wednesday + thursday + friday + saturday + sunday + ongoing + completed + hiatus + english + korean + indonesian + action + comedy + drama + fantasy + heartwarming + historical + horror + mystery + romance + scifi + slice_of_life + sports + super_hero + supernatural + thriller,
                   data = w_train) %>%
  step_dummy(c(daily_pass, monday, tuesday, wednesday, thursday, friday, saturday, sunday, ongoing, completed, hiatus, english, korean, indonesian, action, comedy, drama, fantasy, heartwarming, historical, horror, mystery, romance, scifi, slice_of_life, sports, super_hero, supernatural, thriller)) %>%
  step_normalize(all_predictors())

tree_fit %>%
  extract_fit_engine() %>%
  rpart.plot(roundint = FALSE)

augment(tree_fit, new_data = w_train) %>%
  accuracy(truth = style, estimate = .pred_class)

augment(tree_fit, new_data = w_train) %>%
  conf_mat(truth = style, estimate = .pred_class) %>%
  autoplot(type = "heatmap")

```
